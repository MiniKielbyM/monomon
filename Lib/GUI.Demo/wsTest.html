<!DOCTYPE html>
<html>
<head>
    <title>Minimal Multiplayer Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        
        #status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .waiting { background-color: #d1ecf1; color: #d1b200; }
        
        #messages {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
        }
        
        input, button {
            padding: 8px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>WebSocket Connection Test</h1>
    
    <div>
        <input type="text" id="username" placeholder="Enter username" />
        <button id="connect-btn">Connect</button>
        <button id="disconnect-btn" disabled>Disconnect</button>
    </div>
    
    <div id="status" class="disconnected">Disconnected</div>
    
    <div id="messages"></div>
    
    <script>
        let ws = null;
        let connected = false;
        
        const usernameInput = document.getElementById('username');
        const connectBtn = document.getElementById('connect-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const statusDiv = document.getElementById('status');
        const messagesDiv = document.getElementById('messages');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            messagesDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function updateStatus(status, className) {
            statusDiv.textContent = status;
            statusDiv.className = className;
        }
        
        function connect() {
            const username = usernameInput.value.trim();
            if (!username) {
                alert('Please enter a username');
                return;
            }
            
            // Auto-detect the WebSocket URL for Codespaces
            let wsUrl;
            const hostname = window.location.hostname;
            if (hostname.includes('.app.github.dev')) {
                // GitHub Codespace - use the forwarded port URL
                const baseUrl = hostname.replace('-3000.', '-8080.');
                wsUrl = `wss://${baseUrl}`;
            } else if (hostname === 'localhost' || hostname === '127.0.0.1') {
                // Local development
                wsUrl = 'ws://localhost:8080';
            } else {
                // Generic case - try WebSocket on port 8080
                wsUrl = `ws://${hostname}:8080`;
            }
            
            log(`Connecting to ${wsUrl}...`);
            updateStatus('Connecting...', 'waiting');
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                log('Connected to server');
                updateStatus('Connected', 'connected');
                connected = true;
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                
                // Send join game message
                const message = {
                    type: 'join_game',
                    username: username
                };
                ws.send(JSON.stringify(message));
                log(`Sent join_game message for ${username}`);
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    log(`Received: ${JSON.stringify(data)}`);
                    
                    if (data.type === 'waiting_for_opponent') {
                        updateStatus('Waiting for opponent...', 'waiting');
                    } else if (data.type === 'game_found') {
                        updateStatus(`Game found! Player ${data.playerNumber}`, 'connected');
                        log(`Opponent: ${data.opponent}`);
                    }
                } catch (error) {
                    log(`Error parsing message: ${error.message}`);
                }
            };
            
            ws.onclose = () => {
                log('Disconnected from server');
                updateStatus('Disconnected', 'disconnected');
                connected = false;
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            };
            
            ws.onerror = (error) => {
                log(`WebSocket error: ${error}`);
                updateStatus('Connection error', 'disconnected');
            };
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
            }
        }
        
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        
        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                connect();
            }
        });
    </script>
</body>
</html>