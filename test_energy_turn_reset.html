<!DOCTYPE html>
<html>
<head>
    <title>Energy Turn Reset Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        
        .pokemon-card {
            width: 150px;
            height: 200px;
            background: #4CAF50;
            border-radius: 10px;
            margin: 20px;
            position: relative;
            display: inline-block;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .pokemon-card:hover {
            transform: scale(1.05);
        }
        
        .pokemon-card .card-name {
            text-align: center;
            padding: 10px;
            font-weight: bold;
            color: white;
        }
        
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        button:hover {
            background: #1976D2;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .success { background: rgba(76, 175, 80, 0.3); }
        .error { background: rgba(244, 67, 54, 0.3); }
        .info { background: rgba(33, 150, 243, 0.3); }
        .warning { background: rgba(255, 152, 0, 0.3); }
        
        .turn-display {
            font-size: 18px;
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .flag-display {
            padding: 10px;
            margin: 10px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîÑ Energy Turn Reset Test üîÑ</h1>
        
        <div class="turn-display">
            <strong>Current Turn: <span id="current-turn">1</span></strong><br>
            <span id="turn-status">Your Turn - You can attach energy</span>
        </div>
        
        <div class="flag-display">
            <strong>Energy Attachment Status:</strong><br>
            Attached This Turn: <span id="flag-status">false</span><br>
            Can Attach Energy: <span id="can-attach">true</span>
        </div>
        
        <div class="test-section">
            <h3>üîß Test Controls</h3>
            <button onclick="simulateEnergyAttachment()" id="attach-btn">Attach Energy</button>
            <button onclick="endTurn()">End Turn</button>
            <button onclick="resetTest()">Reset Test</button>
        </div>
        
        <div class="pokemon-card" id="test-pokemon">
            <div class="card-name">Test Pikachu</div>
        </div>
        
        <div id="test-results"></div>
        
        <div class="test-section">
            <h3>üìã Test Log</h3>
            <div id="test-log" style="max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px;"></div>
        </div>
    </div>
    
    <script type="module">
        // Mock Client class
        class MockClient {
            constructor(username) {
                this.username = username;
                this.attachedEnergyThisTurn = false;
                this.hasPlayedSupporterThisTurn = false;
                this.hasPlayedStadiumThisTurn = false;
            }
        }
        
        // Mock GUIHookUtils with the fix
        class MockGUIHookUtils {
            constructor() {
                this.player1 = null;
                this.myTurnFlag = true;
                this.dragEnabled = true;
            }
            
            initializeDragAndDrop(container, player1, game = null) {
                this.player1 = player1;
                this.game = game;
            }
            
            setDragEnabled(enabled, reason = '') {
                this.dragEnabled = enabled;
                this.myTurnFlag = enabled;
                
                // Reset energy attachment flag when it becomes player's turn
                if (enabled && this.player1) {
                    console.log('DEBUG: Turn started, resetting energy attachment flag from:', this.player1.attachedEnergyThisTurn);
                    this.player1.attachedEnergyThisTurn = false;
                    console.log('Turn started: Energy attachment flag reset to:', this.player1.attachedEnergyThisTurn);
                    logMessage(`Turn started: Reset energy flag to ${this.player1.attachedEnergyThisTurn}`);
                }
            }
            
            canAttachEnergy(energyCardData, targetCardData, targetPokemonEl) {
                const playerAttachedEnergyFlag = this.player1 ? this.player1.attachedEnergyThisTurn : false;
                console.log('DEBUG: Checking energy attachment flag:', playerAttachedEnergyFlag);
                
                if (playerAttachedEnergyFlag) {
                    console.log('Energy attachment failed: Already attached energy this turn');
                    logMessage('‚ùå Energy attachment failed: Already attached energy this turn', 'error');
                    return false;
                }
                
                if (!this.myTurnFlag) {
                    console.log('Energy attachment failed: Not your turn');
                    logMessage('‚ùå Energy attachment failed: Not your turn', 'error');
                    return false;
                }
                
                return true;
            }
            
            handleLocalEnergyAttachment(energyCardEl, targetPokemonEl) {
                if (!this.canAttachEnergy({}, {}, targetPokemonEl)) {
                    return false;
                }
                
                // Mark that energy has been attached this turn
                if (this.player1) {
                    this.player1.attachedEnergyThisTurn = true;
                    logMessage(`‚úÖ Energy attached! Flag set to ${this.player1.attachedEnergyThisTurn}`, 'success');
                }
                
                return true;
            }
            
            isMyTurn() {
                return this.myTurnFlag;
            }
        }
        
        // Test setup
        let currentTurn = 1;
        let isMyTurn = true;
        const client = new MockClient('TestPlayer');
        const guiHook = new MockGUIHookUtils();
        
        // Initialize
        guiHook.initializeDragAndDrop(document.body, client);
        
        function updateDisplay() {
            document.getElementById('current-turn').textContent = currentTurn;
            document.getElementById('turn-status').textContent = isMyTurn ? 
                'Your Turn - You can attach energy' : 
                'Opponent\'s Turn - Wait for your turn';
            document.getElementById('flag-status').textContent = client.attachedEnergyThisTurn;
            
            const canAttach = guiHook.canAttachEnergy({}, {}, null);
            document.getElementById('can-attach').textContent = canAttach;
            document.getElementById('can-attach').style.color = canAttach ? '#4CAF50' : '#f44336';
            
            const attachBtn = document.getElementById('attach-btn');
            attachBtn.disabled = !canAttach;
            attachBtn.textContent = canAttach ? 'Attach Energy' : 'Cannot Attach Energy';
        }
        
        function logMessage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('test-log');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #888;">[${timestamp}]</span> ${message}`;
            logEntry.className = type;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // Also add to results
            const resultsDiv = document.getElementById('test-results');
            const resultEntry = document.createElement('div');
            resultEntry.className = `status ${type}`;
            resultEntry.textContent = message;
            resultsDiv.appendChild(resultEntry);
            
            // Keep only last 5 results
            while (resultsDiv.children.length > 5) {
                resultsDiv.removeChild(resultsDiv.firstChild);
            }
        }
        
        window.simulateEnergyAttachment = function() {
            logMessage(`Attempting to attach energy on turn ${currentTurn}...`, 'info');
            const success = guiHook.handleLocalEnergyAttachment(null, document.getElementById('test-pokemon'));
            updateDisplay();
            return success;
        };
        
        window.endTurn = function() {
            logMessage(`Ending turn ${currentTurn}`, 'info');
            
            // Simulate server turn end (resets flags)
            client.attachedEnergyThisTurn = false;
            client.hasPlayedSupporterThisTurn = false;
            client.hasPlayedStadiumThisTurn = false;
            
            currentTurn++;
            isMyTurn = !isMyTurn;
            
            // Simulate turn change with setDragEnabled call
            guiHook.setDragEnabled(isMyTurn, isMyTurn ? 'Your turn' : 'Opponent turn');
            
            logMessage(`Turn ${currentTurn} started. ${isMyTurn ? 'Your turn!' : 'Opponent\'s turn.'}`, 'success');
            updateDisplay();
        };
        
        window.resetTest = function() {
            currentTurn = 1;
            isMyTurn = true;
            client.attachedEnergyThisTurn = false;
            client.hasPlayedSupporterThisTurn = false;
            client.hasPlayedStadiumThisTurn = false;
            guiHook.setDragEnabled(true, 'Test reset');
            
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('test-log').innerHTML = '';
            
            logMessage('Test reset to initial state', 'info');
            updateDisplay();
        };
        
        // Initial display update
        updateDisplay();
        logMessage('Energy turn reset test initialized', 'info');
        
        // Test scenario
        window.runFullTest = function() {
            logMessage('Running full test scenario...', 'info');
            
            setTimeout(() => {
                simulateEnergyAttachment(); // Should succeed
                setTimeout(() => {
                    simulateEnergyAttachment(); // Should fail (already attached)
                    setTimeout(() => {
                        endTurn(); // End turn, should reset flag
                        setTimeout(() => {
                            simulateEnergyAttachment(); // Should succeed again
                        }, 500);
                    }, 500);
                }, 500);
            }, 500);
        };
        
        // Add auto-test button
        const autoTestBtn = document.createElement('button');
        autoTestBtn.textContent = 'Run Full Test';
        autoTestBtn.onclick = runFullTest;
        document.querySelector('.test-section').appendChild(autoTestBtn);
    </script>
</body>
</html>